---
title: "Pseudotime analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Pseudotime analysis}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, warning=FALSE, message=FALSE}
library(cyCONDOR)
library(pheatmap)
library(ggplot2)
library(dplyr)
```

```{r, include= FALSE}
library(dplyr)
library(flowCore)
library(Rphenograph)
library(slingshot)

#load functions 
source("../repo/cyCONDOR/R/batch_correction.R")
source("../repo/cyCONDOR/R/data_load_and_transform.R")
source("../repo/cyCONDOR/R/data_visualization.R")
source("../repo/cyCONDOR/R/dim_reduction.R")
source("../repo/cyCONDOR/R/colors.R")
source("../repo/cyCONDOR/R/clustering.R")
source("../repo/cyCONDOR/R/misc.R")
source("../repo/cyCONDOR/R/pseudotime.R")

```

With `cyCONDOR` we implemented `slingshot` for pseudotome analysis, following a workflow to calculate trajectories and pseudotime.

## Load the cyCONDOR object

We start here by loading an example `condor` object already annotated.

```{r}
condor <- readRDS("../../data/.test_files/condor_pseudotime.rds")
```

```{r}
plot_dim_red(fcd= condor,  
             expr_slot = NULL,
             reduction_method = "umap", 
             reduction_slot = "pca_orig", 
             cluster_slot = "Phenograph_filter_pca_orig_k_10",
             param = "metaclusters",
             title = "UMAP colored by Phenograph",
             alpha= 1, dot_size = 1)
```

```{r, fig.height=7}
plot_marker_HM(fcd = condor,
               expr_slot = "orig",
               cluster_slot = "Phenograph_filter_pca_orig_k_10",
               cluster_var = "Phenograph",
               cluster_rows = TRUE,
               cluster_cols = TRUE,
               title= "Marker expression Phenograph clustering")
```

# Pseudotime analysis

We can now calculate the pseudotime with different settings:

## With no constrains on the start of the trajectory

```{r}
condor <- runPseudotime(fcd = condor, 
                        reduction_method = "umap",
                        reduction_slot = "pca_orig",
                        cluster_slot= "Phenograph_filter_pca_orig_k_10",
                        cluster_var = "metaclusters",
                        approx_points = 5)
```
The output of is saved in `condor$pseudotime$slingshot_umap_pca_orig`.

```{r}
condor$pseudotime$slingshot_umap_pca_orig[1:5,]
```


## With a specific starting cluster

```{r}

condor <- runPseudotime(fcd = condor, 
                        reduction_method = "umap",
                        reduction_slot = "pca_orig",
                        cluster_slot= "Phenograph_filter_pca_orig_k_10",
                        cluster_var = "metaclusters",
                        approx_points = 5,
                        start.clus =  "CMPs",)


```

The output of is saved in `condor$pseudotime$slingshot_umap_pca_orig_CMPs`.

```{r}
condor$pseudotime$slingshot_umap_pca_orig_CMPs[1:5,]
```


## Testing all clusters as starting point

```{r}
for (i in unique(condor$clustering$Phenograph_filter_pca_orig_k_10$metaclusters)[1:5]) {
  
  condor <- runPseudotime(fcd = condor, 
                          reduction_method = "umap",
                          reduction_slot = "pca_orig",
                          cluster_slot= "Phenograph_filter_pca_orig_k_10",
                          cluster_var = "metaclusters",
                          approx_points = 5,
                          start.clus =  i)
  
}
```

Can we plot this using the plot_dim_red() function?
```{r, eval=FALSE}
plot_marker(data = cbind(condor$umap$pca_orig, condor$clustering$Phenograph_filter_pca_orig_k_10, condor$pseudotime$slingshot_umap_pca_orig), 
                   param = "mean", 
                   order = T, 
                   title = "Figure 4e - UMAP mean pseudotime", 
                   dim_red = "UMAP", 
                   facet_by_variable = FALSE, dot_size = 1, apha = 1) + 
  geom_path(data = condor$extras$slingshot_umap_pca_orig$lineages %>% arrange(Order), aes(group = Lineage), size = 0.5)
```



# Heatmap visualization of trajectory

## DCs
```{r}
selections <- rownames(condor$clustering$Phenograph_filter_pca_orig_k_10[condor$clustering$Phenograph_filter_pca_orig_k_10$metaclusters %in% c("HSCs", "Pre-DC", "pDCs"), ])

condor_dcs <- filter_fcd(fcdataset = condor,
                            cell_ids = selections)
```

```{r}
expression <- condor_dcs$expr$orig

anno <- cbind(condor_dcs$clustering$Phenograph_filter_pca_orig_k_10[, c("Phenograph", "metaclusters")], condor_dcs$pseudotime$slingshot_umap_pca_orig)

anno <- anno[order(anno$Lineage2, decreasing = TRUE),]

expression <- expression[rownames(anno), c("174-HLADR", "151-CD123", "148-CD34")]

my_colour = list(metaclusters = c(HSCs = "#689030", pDCs = "#CD9BCD", `Pre-DC` = "#2B3990"))
```

```{r}
pheatmap(mat = expression, 
         scale = "column", 
         show_rownames = FALSE, 
         cluster_rows = F, 
         cluster_cols = F, 
         annotation_row = anno[, c("metaclusters", "Lineage2")], 
         annotation_colors = my_colour, 
         breaks = scaleColors(expression, maxvalue = 2)[["breaks"]], 
         color = scaleColors(expression, maxvalue = 2)[["color"]], 
         main = "Figure S6b - Heatmap pDCs trajectory")
```

## Monocytes
```{r}
selections <- rownames(condor$clustering$Phenograph_filter_pca_orig_k_10[condor$clustering$Phenograph_filter_pca_orig_k_10$metaclusters %in% c("HSCs", "CMPs", "Myeloblast", "Monocytes"), ])

condor_mono <- filter_fcd(fcdataset = condor,
                            cell_ids = selections)
```

```{r}
expression <- condor_mono$expr$orig

anno <- cbind(condor_mono$clustering$Phenograph_filter_pca_orig_k_10[, c("Phenograph", "metaclusters")], condor_mono$pseudotime$slingshot_umap_pca_orig)

anno <- anno[order(anno$Lineage2, decreasing = FALSE),]

expression <- expression[rownames(anno), c("148-CD34", "160-CD14", "144-CD11b")]

my_colour = list(metaclusters = c(Monocytes = "#CBD588", HSCs = "#689030", Myeloblast = "#DA5724", CMPs = "#F7941D"))
```

```{r}
pheatmap(mat = expression, 
         scale = "column", 
         show_rownames = FALSE, 
         cluster_rows = F, 
         cluster_cols = F, 
         annotation_row = anno[, c("metaclusters", "Lineage2")], 
         annotation_colors = my_colour, 
         breaks = scaleColors(expression, maxvalue = 2)[["breaks"]], 
         color = scaleColors(expression, maxvalue = 2)[["color"]], main = "Figure 4f - Heatmap Monocytes pseudotime")
```

# Session Info
```{r}
info <- sessionInfo()

info
```
