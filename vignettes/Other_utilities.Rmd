---
title: "Introduction to the condor object and other utilities"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Other utilities}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, warning=FALSE, message=FALSE}
library(cyCONDOR)
```

In this vignette we introduce the structure of the condor object and showcase some useful `cyCONDOR` functions to interact with it. 

# Load example cyCONDOR object
```{r}
condor <- readRDS("../.test_files/condor_example_016_misc.rds")
#condor <- readRDS("/data/analysis/jacqueline/others/condor_example_016_misc.rds")
```

# Structure of the condor object 

**to be added by Charlotte**


# Extract or change marker names

## measured markers

The function `measured_markers` takes the condor object as `fcd` input and returns the number of markers that are included in the condor object and a list of their names. By directing the output to a variable it is possible to save the list of the marker names for future use.

```{r}
expr_markers <- measured_markers(fcd = condor)
```
## Change parameter names

The function `change_param_name` allows for the quick and easy changing of single or multiple parameter names. It needs the condor object as `fcd` input and vectors for the old and new parameter names (`old_names` and `new_names`, respectively). In the first example we change only the name of the *PD-1* marker to *PD1*. 

```{r}
condor <- change_param_name(fcd = condor, 
                            old_names = "PD-1", 
                            new_names = "PD1")
```
It is also possible to modify multiple names at the same time. The vector *NewNames* can either be written manually or computed using vector manipulations. In the second example below we exclude the protein names from the specific markers. It is important, that the order of the old and new marker names stay the same.

```{r}
OldNames <- c("CD195 (CCR5)", "CD94 (KLRD1)", "CD127 (IL7RA)", "CD197 (CCR7)", "CD123 (IL3RA)")
NewNames <- unlist(strsplit(OldNames, " "))[2*(1:length(OldNames))-1] 

condor <- change_param_name(fcd = condor, 
                            old_names = OldNames, 
                            new_names = NewNames)
```
## used_markers

To keep track on which markers have been used as basis for dimensionality reduction or clustering the respective markers are being saved in the extra slot of the `condor` object. The `used_markers` function can be used to extract those markers. 

It takes as input

* the `fcd` object    (e.g. condor),
* the `input_type`    (pca,  umap, tSNE, diffmap, phenograph or FlowSOM),
* the `data_slot`     (orig or norm),
* the `prefix`        (if specified before, see dimensionality reduction or clustering) 

and returns, similar to the `measured_markers` function, the number and names of the markers used for the specific analysis step.

```{r}
pca_orig_markers <- used_markers(fcd = condor, 
                                 input_type = "pca", 
                                 data_slot = "orig",
                                 prefix = NULL)
```
Below we show an example of markers used for the PCA calculation with an exclusion of the scatter markers `FSC-A` and `SSC-A`. The `prefix` used in this PCA calculation was defines as *scatter_exclusion*.

```{r}
pca_scatter_exclusion_orig_markers <- used_markers(fcd = condor, 
                                 input_type = "pca", 
                                 data_slot = "orig",
                                 prefix = "scatter_exclusion")
```

# Check the integrity of the condor object

The `check_IDs` function can be useful to make sure the condor object has the right structure for all downstream analysis. It checks the cell IDs at each level and compares them to the `fcd$expr$orig` data frame. If a discrepancy appears at any point, a warning will be returned.

```{r}
check_IDs(condor)
```

# Merge or subset the condor object

## Merge two condor objects

The `merge_condor` function combines two `condor` objects comprised of the same parameters (markers). This function will merge only expression table and annotation as all the downstream analysis will need to be repeated. If the cell IDs are doubled between the two objects the merging can not be facilitated.

```{r}
condor_merged <- merge_condor(data1 = condor, 
                              data2 = condor)
```

## Subset a condor object

The 'subset_fcd' function subsets the `condor` object to a specific number of randomly selected cells specified with the `size` parameter. A seed can be set for reproducibility.

```{r}
condor_subset <- subset_fcd(fcd = condor, 
                            size = 5000,
                            seed = 91)
```

## Filter a condor object to create a specific subset

The `filter_fcd` function can be useful to created a specific subset of a `condor` object. It takes the row names of the cells to be filtered as `cell_ids` input.

```{r}
condor_filter <- filter_fcd(fcd = condor, 
                            cell_ids = rownames(condor$expr$orig)[condor$clustering$phenograph_pca_orig_k_60$metaclusters == "Classical Monocytes"])
```

# Session Info
```{r}
info <- sessionInfo()

info
```
